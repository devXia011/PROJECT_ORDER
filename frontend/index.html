<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auth Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-100 via-gray-200 to-gray-300 min-h-screen flex flex-col">
  <div id="app" class="flex flex-col flex-1">
    <!-- Navbar -->
    <nav v-if="loggedIn" class="bg-indigo-600 text-white shadow-md transition">
      <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <span class="text-lg font-semibold">My Web App</span>
        <div class="flex items-center space-x-4">
          <span class="text-sm">Welcome, {{ username }}</span>
          <button @click="logout"
                  class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm font-medium transition transform hover:scale-105">
            Logout
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="flex flex-1 items-center justify-center px-4">
      <!-- Login Card -->
      <div v-if="!loggedIn" key="login"
           class="w-full max-w-md bg-white rounded-xl shadow-xl p-8 transform transition hover:scale-[1.01]">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Sign In</h1>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">Username</label>
            <input v-model="username" type="text"
                   class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">Password</label>
            <input v-model="password" type="password"
                   class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" />
          </div>
          <button @click="login"
                  class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700 transition transform hover:scale-105">
            Login
          </button>
          <p v-if="error" class="text-red-500 text-sm text-center mt-2">{{ error }}</p>
        </div>
      </div>

      <!-- Profile Card -->
      <div v-else key="profile"
           class="w-full max-w-lg bg-white rounded-xl shadow-xl p-8 transform transition hover:scale-[1.01]">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Profile</h1>
        <p class="text-gray-600 mb-6">You are logged in as <strong>{{ username }}</strong>.</p>
        <button @click="fetchProtected"
                class="bg-green-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-600 transition transform hover:scale-105">
          Access Protected Route
        </button>
        <p v-if="message" class="mt-4 text-gray-700">{{ message }}</p>
      </div>
    </main>
  </div>

  <!-- Vue App -->
  <script>
    const { createApp } = Vue
    createApp({
      data() {
        return {
          username: '',
          password: '',
          loggedIn: false,
          error: null,
          message: null
        }
      },
      async mounted() {
        const res = await fetch("/session", { credentials: "include" })
        if (res.ok) {
          const data = await res.json()
          if (data.authenticated) {
            this.loggedIn = true
            this.username = data.username
          }
        }
      },
      methods: {
        async login() {
          this.error = null
          try {
            const res = await fetch("/login", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ username: this.username, password: this.password }),
              credentials: "include"
            })
            if (!res.ok) throw new Error("Invalid credentials")
            this.loggedIn = true
          } catch (err) { this.error = err.message }
        },
        async fetchProtected() {
          const csrfToken = this.getCookie("csrf_token")
          const res = await fetch("/protected", {
            method: "POST",
            credentials: "include",
            headers: { "X-CSRF-Token": csrfToken }
          })
          this.message = res.ok ? (await res.json()).message : "Access denied"
        },
        async logout() {
          await fetch("/logout", { method: "POST", credentials: "include" })
          this.loggedIn = false
          this.message = null
          this.password = ''
        },
        getCookie(name) {
          const value = `; ${document.cookie}`
          const parts = value.split(`; ${name}=`)
          if (parts.length === 2) return parts.pop().split(";").shift()
        }
      }
    }).mount('#app')
  </script>
</body>
</html>