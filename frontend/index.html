<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure JWT Cookie Auth Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app">
    <nav v-if="loggedIn" class="bg-blue-600 text-white p-4 flex justify-between">
      <span class="font-bold">My Web App</span>
      <span>Welcome, {{ username }}</span>
      <button @click="logout" class="bg-red-500 px-3 py-1 rounded hover:bg-red-600">
        Logout
      </button>
    </nav>

    <div class="flex items-center justify-center min-h-screen">
      <div v-if="!loggedIn" class="w-full max-w-md p-6 bg-white rounded shadow">
        <h1 class="text-2xl font-bold mb-4">Login</h1>
        <input v-model="username" type="text" placeholder="Username"
               class="w-full p-2 mb-3 border rounded" />
        <input v-model="password" type="password" placeholder="Password"
               class="w-full p-2 mb-3 border rounded" />
        <button @click="login"
                class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
          Login
        </button>
        <p v-if="error" class="text-red-500 mt-2">{{ error }}</p>
      </div>

      <div v-else class="w-full max-w-lg p-6 bg-white rounded shadow">
        <h1 class="text-2xl font-bold mb-4">Profile Page</h1>
        <p class="text-gray-700 mb-4">You are logged in as <strong>{{ username }}</strong>.</p>
        <button @click="fetchProtected"
                class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600">
          Access Protected Route
        </button>
        <p v-if="message" class="mt-4 text-gray-700">{{ message }}</p>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue
    createApp({
      data() {
        return {
          username: '',
          password: '',
          loggedIn: false,
          error: null,
          message: null
        }
      },
      async mounted() {
        // Check session on page load
        const res = await fetch("/session", { credentials: "include" })
        if (res.ok) {
          const data = await res.json()
          if (data.authenticated) {
            this.loggedIn = true
            this.username = data.username
          }
        }
      },
      methods: {
        async login() {
          this.error = null
          try {
            const res = await fetch("/login", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ username: this.username, password: this.password }),
              credentials: "include"
            })
            if (!res.ok) throw new Error("Invalid credentials")
            this.loggedIn = true
          } catch (err) { this.error = err.message }
        },
        async fetchProtected() {
          const csrfToken = this.getCookie("csrf_token")
          const res = await fetch("/protected", {
            method: "POST",
            credentials: "include",
            headers: { "X-CSRF-Token": csrfToken }
          })
          this.message = res.ok ? (await res.json()).message : "Access denied"
        },
        async logout() {
          await fetch("/logout", { method: "POST", credentials: "include" })
          this.loggedIn = false
          this.message = null
          this.password = ''
        },
        getCookie(name) {
          const value = `; ${document.cookie}`
          const parts = value.split(`; ${name}=`)
          if (parts.length === 2) return parts.pop().split(";").shift()
        }
      }
    }).mount('#app')
  </script>
</body>
</html>